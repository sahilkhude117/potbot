
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String     @id @default(uuid())
  telegramUserId   String     @unique
  publicKey        String     @unique
  privateKey       String     // will store in mpc later

  potsCreated      Pot[]     @relation("AdminRelation")
  potMemberships   Pot_Member[]   

  createdAt        DateTime   @default(now())
}

model Pot {
  id               String     @id @default(uuid())
  name             String
  telegramGroupId  String     @unique
  inviteLink       String?
  vaultAddress     String     @unique

  isGroupAdded     Boolean    @default(false)

  adminId          String
  admin            User       @relation("AdminRelation", fields: [adminId], references: [id])

  members          Pot_Member[]
  trades           Trade[]
  assets           Asset[]

  deposits         Deposit[]
  withdrawals      Withdrawal[]
  redemptionTrades RedemptionTrade[]

  totalShares      BigInt     @default(0)
  accruedAdminFees BigInt     @default(0)

  cashOutMint      String     @default("So11111111111111111111111111111111111111112")
  redemptionFeeBps Int        @default(0)
  performanceFeeBps Int       @default(0)
  maxRedeptionSlippageBps Int @default(50)

  createdAt        DateTime   @default(now())
}

model Pot_Member {
  id               String     @id @default(uuid())
  userId           String
  potId            String
  joinedAt         DateTime   @default(now())

  role             Role       @default(MEMBER)
  user             User       @relation(fields: [userId], references: [id])
  pot              Pot        @relation(fields: [potId], references: [id])

  tradesExecuted   Trade[]

  shares           BigInt     @default(0)
  depositRecords   Deposit[]
  withdrawalRecords Withdrawal[]

  @@unique([userId, potId]) // user can only join once per pot
}

model Deposit {
  id               String     @id @default(uuid())
  potId            String
  pot              Pot        @relation(fields: [potId], references: [id])
  userId           String
  member           Pot_Member @relation(fields: [userId, potId], references: [userId, potId])

  amount           BigInt
  sharesMinted     BigInt
  timestamp        DateTime   @default(now())
}

model Withdrawal {
  id               String     @id @default(uuid())
  potId            String
  pot              Pot        @relation(fields: [potId], references: [id])
  userId           String
  member           Pot_Member @relation(fields: [userId, potId], references: [userId, potId])

  sharesBurned     BigInt
  amountOut        BigInt

  redemptionTrades RedemptionTrade[]

  timestamp        DateTime   @default(now())
}

enum Role {
  ADMIN
  TRADER
  MEMBER
}

model Trade {
  id               String      @id @default(uuid())
  potId            String
  pot              Pot         @relation(fields: [potId], references: [id])

  traderId         String
  trader           Pot_Member  @relation(fields: [traderId], references: [id])

  inMint           String
  inAmount         BigInt
  outMint          String
  outAmount        BigInt

  txSignature      String      @unique

  status           TradeStatus @default(PENDING)
  createdAt        DateTime    @default(now())
}

model RedemptionTrade {
  id               String      @id @default(uuid())
  potId            String
  pot              Pot         @relation(fields: [potId], references: [id])
  withdrawalId     String
  withdrawal       Withdrawal  @relation(fields: [withdrawalId], references: [id])

  sellMint         String
  sellAmount       BigInt
  buyMint          String
  buyAmount        BigInt
  price            Decimal
  slippageBps      Int         @default(50)
  timestamp        DateTime    @default(now())
}

model Asset {
  id               String      @id @default(uuid())
  potId            String
  pot              Pot         @relation(fields: [potId], references: [id])

  mintAddress      String
  balance          BigInt
  pendingSale      BigInt      @default(0)

  updatedAt        DateTime    @updatedAt

  @@unique([potId, mintAddress])
}

enum TradeStatus {
  COMPLETED
  PENDING
  FAILED
}

